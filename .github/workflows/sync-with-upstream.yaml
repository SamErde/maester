# Perform a hard reset of the fork's main branch to match the upstream repository's main branch.
# If divergence is detected, preserve commits in a backup branch and an annotated tag with metadata.
name: Sync fork with upstream

on:
  schedule:
    - cron: "0 3 * * *"
  workflow_dispatch:

env:
  REQUIRE_FORK: true

jobs:
  sync:
    runs-on: ubuntu-latest

    # Safety check to only run on a fork
    if: |
      github.event.repository.fork == true &&
      github.repository_owner == github.event.repository.owner.login


    steps:
      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v4 pinned
        with:
          fetch-depth: 0

      - name: Configure Git identity
        shell: bash
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: Add upstream remote (fetch-only) and fetch
        shell: bash
        run: |
          git remote add upstream https://github.com/maester365/maester.git 2>/dev/null || true
          git fetch upstream

      - name: Detect divergence and preserve commits
        id: backup
        shell: bash
        run: |
          set -euo pipefail

          git checkout main

          UPSTREAM_SHA=$(git rev-parse upstream/main)
          ORIGINAL_SHA=$(git rev-parse main)
          TIMESTAMP=$(date -u +%Y%m%dT%H%M%SZ)

          if git merge-base --is-ancestor upstream/main main; then
            echo "âœ… No divergence detected"
            echo "diverged=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          BACKUP_BRANCH="backup-main-${TIMESTAMP}"
          BACKUP_TAG="backup-main-${TIMESTAMP}"

          COMMITS=$(git log upstream/main..main --oneline)

          echo "âš ï¸ Divergence detected"
          echo "ðŸ“Œ Creating backup branch: ${BACKUP_BRANCH}"
          echo "ðŸ·ï¸ Creating annotated tag: ${BACKUP_TAG}"
          echo "ðŸ§¾ Preserved commits:"
          echo "${COMMITS}"

          # Create backup branch
          git branch "${BACKUP_BRANCH}"

          # Create annotated tag with structured metadata
          git tag -a "${BACKUP_TAG}" \
            -m "type: fork-sync-backup" \
            -m "branch: main" \
            -m "reason: divergence-from-upstream" \
            -m "timestamp: ${TIMESTAMP}" \
            -m "upstream_sha: ${UPSTREAM_SHA}" \
            -m "original_main_sha: ${ORIGINAL_SHA}"

          # Export outputs
          {
            echo "diverged=true"
            echo "backup_branch=${BACKUP_BRANCH}"
            echo "backup_tag=${BACKUP_TAG}"
            echo "upstream_sha=${UPSTREAM_SHA}"
            echo "original_sha=${ORIGINAL_SHA}"
          } >> "$GITHUB_OUTPUT"

          # Write job summary
          {
            echo "## âš ï¸ Fork Divergence Detected"
            echo ""
            echo "**Backup branch:** \`${BACKUP_BRANCH}\`"
            echo ""
            echo "**Backup tag:** \`${BACKUP_TAG}\`"
            echo ""
            echo "**Upstream SHA:** \`${UPSTREAM_SHA}\`"
            echo ""
            echo "**Original main SHA:** \`${ORIGINAL_SHA}\`"
            echo ""
            echo "### ðŸ§¾ Preserved commits"
            echo ""
            echo '```text'
            echo "${COMMITS}"
            echo '```'
            echo ""
            echo "[View workflow run](${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID})"
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Reset main to upstream/main
        shell: bash
        run: |
          git checkout main
          git reset --hard upstream/main

      - name: Push changes to fork
        shell: bash
        run: |
          git push origin main --force-with-lease
          git push origin --tags
